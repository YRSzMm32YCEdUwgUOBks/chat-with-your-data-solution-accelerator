# Local Development (Fast Start)

> ‚ÑπÔ∏è **Info:** This project is currently a stubbed-out framework. The local environment and Autogen load successfully, but core business logic and integrations are not yet implemented. This is a foundation for further development, not a production-ready or feature-complete solution.

**Updated: 2025-05-06**
This document reflects the latest, fully Dockerized local workflow‚Äîbefore merging with frontend code.
**Note:** All backend and admin functionality now lives in `code/azure_function`, which replaces the legacy `backend` and `admin` services/sites.

---

## Service Overview

| Service         | Port Mapping     | Description                                                    |
|-----------------|------------------|----------------------------------------------------------------|
| **frontend**        | 8080 ‚Üí 80       | React UI (Vite, hot reload in Docker)                          |
| **azure_function**  | 8088 ‚Üí 80       | Azure Functions API (Python, replaces backend & admin)         |
| **postgres**        | 5432 ‚Üí 5432     | PostgreSQL (with pgvector)                                     |
| **azurite**         | 10000+ ‚Üí 10000+ | Azure Blob/Queue/Table emulator                                |
| **migrate**         | n/a             | DB migration/init (runs at build time via `migrate` service)   |

---

## 1Ô∏è‚É£ Clone the Repo *Inside WSL*

**Why?**
Cloning inside WSL avoids slow file access between Windows and Linux filesystems.

```bash
git clone https://github.com/YRSzMm32YCEdUwgUOBks/chat-with-your-data-solution-accelerator.git
cd chat-with-your-data-solution-accelerator
cp .env.example .env
# edit .env as needed
```

---

## 2Ô∏è‚É£ Open in VS Code (Dev Container)

- From your WSL terminal, run:
  ```bash
  code .
  ```
- VS Code will prompt: **"Reopen in Container"**.
  If you miss it, open the Command Palette and search for "Reopen in Container".

  ![Reopen in Container Prompt](images/cwyd-localdeploy-reopenincontainerprompt.png)

- **First build:** ~10 minutes (downloads images, builds containers).
  **Subsequent builds:** ~2 minutes.

  ![Devcontainer Startup](images/cwyd-localdeploy-reopenincontainerrun.png)

---

## 3Ô∏è‚É£üöÄ Start All Services

This should happen automatically when the devcontainer reopens. Otherwise:

```bash
./start.sh
```

Or manually:

```bash
docker compose -f docker-compose.local.yml up -d
```

- Loads `.env` and starts all services.
- **To tail all logs in real time (recommended):**
  ```bash
  docker compose -f docker-compose.local.yml logs -f
  ```

---

## ‚úèÔ∏è Logging & Host Configuration

When running Azure Functions inside Docker, you‚Äôll see two main sources of ‚Äúnoise‚Äù in your console:

1. **Runtime telemetry** such as lock-lease heartbeats, metrics flushes, and dependency-tracking logs (MS_FUNCTION_LOGS / MS_FUNCTION_METRICS) emitted by the Functions host by default to support Application Insights and scaling decisions ([Functions monitoring](https://learn.microsoft.com/azure/azure-functions/functions-monitoring)).
2. **Azurite emulator traffic** (periodic PUT requests to `/devstoreaccount1/azure-webjobs-hosts/locks...`) generated by the local Blob/Queue/Table emulator.

### Why `host.json` still matters in containers

- The Functions runtime **always** reads `host.json` at the root of your function app‚Äîeven inside a container‚Äîso any logging levels or console settings you configure there will be honored at startup ([host.json reference](https://learn.microsoft.com/azure/azure-functions/functions-host-json)).
- **local.settings.json** is **not** loaded inside Docker; supply those same values as environment variables instead ([Stack Overflow: local.settings.json not loaded in containers](https://stackoverflow.com/questions/65050688/azure-functions-kubernetes-cannot-find-local-settings-json)).
- You can override any `host.json` setting at runtime via env vars:
  ```dockerfile
  ENV AzureFunctionsJobHost__logging__console__isEnabled=false
  ENV AzureFunctionsJobHost__logging__console__disableColors=true
  ```
  _See the [Console logging section](https://learn.microsoft.com/azure/azure-functions/functions-host-json#console) of the host.json reference._

### On-the-fly `grep`-based filtering

For many teams it‚Äôs easiest to keep your container image identical to production (no baked-in monitoring changes) and filter noise at the CLI:

1. Create `docker-logging-ignore-events.txt` next to `docker-compose.local.yml` with **only** these regexes:
   ```text
   MS_FUNCTION_(LOGS|METRICS)
   azurite-cwyd
   PUT /devstoreaccount1/azure-webjobs-hosts/locks//host\?comp=lease
   System\.UriFormatException.*LinuxContainerMetricsPublisher
   ```
2. Tail and filter:
   ```bash
   docker compose -f docker-compose.local.yml logs -f \
     | grep --line-buffered -E -v -f docker-logging-ignore-events.txt
   ```

> üí° **Why prefer CLI filtering?**
> This approach preserves the exact same container and host settings you‚Äôll deploy to production‚Äîno need to disable monitoring or rebuild images with different `host.json` values, ensuring parity between dev and prod environments.

---

### üê≥ Docker Compose Command Reference

| Command                                     | Rebuild?     | Recreate?   | Remove Containers? | Notes                                     |
| ------------------------------------------- | ------------ | ----------- | ------------------ | ----------------------------------------- |
| `docker restart <svc>`                      | ‚ùå           | ‚úÖ          | ‚ùå                 | Fast container bounce                     |
| `docker compose up -d`                      | ‚ùå           | Maybe       | ‚ùå                 | Uses existing images/containers           |
| `docker compose up -d --build`              | ‚úÖ (cached)  | Maybe       | ‚ùå                 | Rebuild if needed                         |
| `docker compose up -d --build --force-recreate` | ‚úÖ       | ‚úÖ          | ‚ùå                 | Full clean container setup                |
| `docker compose down --rmi all --volumes`   | ‚ùå           | ‚úÖ          | ‚úÖ                 | Full cleanup (containers, images, volumes)|
| `docker system prune -a`                    | ‚úÖ           | ‚úÖ          | ‚úÖ                 | Full system wipe ‚Äî only for brave souls   |

---

## 4Ô∏è‚É£ Access the Apps

- **Frontend:** [http://localhost:8080/](http://localhost:8080/)
- **API/Backend:** [http://localhost:8088/](http://localhost:8088/)

> The `azure_function` service now handles **all** backend and admin endpoints‚Äîthere is no separate admin UI or Flask service.

---

## 5Ô∏è‚É£ Typical Workflow

- Edit code in:
  - `code/frontend`
  - `code/azure_function` (all API & admin logic)
- Frontend hot-reloads automatically in Docker.
- Azure Function container picks up `host.json` changes on rebuild or via mounted volume.
- Database and storage persist unless Docker volumes are removed.

---

## üî¨ Advanced: Run Individual Services

_Optional for non-Docker debugging._

**Frontend only:**
```bash
cd code/frontend
npm install
npm run dev
# ‚Üí http://localhost:5174/
```

**Azure Function only:**
```bash
cd code/azure_function
pip3 install -r requirements.txt
func start --python
# ‚Üí http://localhost:7071/
```

---

## üõ†Ô∏è Troubleshooting

- **Docker not running?** Start Docker Desktop before launching WSL/VS Code.
- **Dev Container build slow?** Ensure you‚Äôre on WSL, not Windows filesystem.
- **host.json not applying?** Rebuild the container or mount over `/home/site/wwwroot/host.json` ([Stack Overflow issue](https://stackoverflow.com/questions/63130799/azure-functions-host-json-not-applying-to-azure-application-settings)).
- **Missing settings in container?** Remember: `local.settings.json` is ignored‚Äîuse env vars instead.

---

## Reference

- [host.json reference (Azure Functions)](https://learn.microsoft.com/azure/azure-functions/functions-host-json)
- [Monitor executions in Azure Functions](https://learn.microsoft.com/azure/azure-functions/functions-monitoring)
- [Develop and run Azure Functions locally](https://learn.microsoft.com/azure/azure-functions/functions-develop-local)
- [Working with containers and Azure Functions](https://learn.microsoft.com/azure/azure-functions/functions-how-to-custom-container)
- [Create your first containerized Azure Functions on Azure Container Apps](https://learn.microsoft.com/azure/azure-functions/functions-deploy-container-apps)
- [host.json override values (env vars)](https://learn.microsoft.com/azure/azure-functions/functions-host-json#override-hostjson-values)

---

## üîë Environment variables

Set these in your `.env` file (see `.env.example`):

| Variable                       | Example                   | Service                     | Purpose                                     |
|--------------------------------|---------------------------|-----------------------------|---------------------------------------------|
| `POSTGRESQL_USER`              | `postgres`                | PostgreSQL                  | DB user                                     |
| `POSTGRESQL_PASSWORD`          | `postgres`                | PostgreSQL                  | DB password                                 |
| `POSTGRESQL_DB`                | `postgres`                | PostgreSQL                  | DB name                                     |
| `POSTGRESQL_HOST`              | `postgres`                | PostgreSQL                  | DB host (service name)                      |
| `AZURE_BLOB_ACCOUNT_NAME`      | `devstoreaccount1`        | Azurite (Blob)              | Emulator account name                       |
| `AZURE_BLOB_ACCOUNT_KEY`       | (see `.env.example`)      | Azurite (Blob)              | Emulator account key                        |
| `AzureWebJobsStorage`          | (see `.env.example`)      | Azurite (all)               | Connection string for storage emulation     |
| `VITE_BACKEND_URL`             | `http://localhost:8088`   | Frontend                    | API base URL for Vite                       |
| `AZURE_OPENAI_API_KEY`         | (your key or blank)       | Azure OpenAI                | Only if testing OpenAI locally              |
| `AZURE_OPENAI_MODEL_NAME`      | `gpt-4o-mini`             | Azure OpenAI                | (Optional default)                          |
| `AZURE_OPENAI_EMBEDDING_MODEL` | `text-embedding-3-large`  | Azure OpenAI                | (Optional default)                          |
